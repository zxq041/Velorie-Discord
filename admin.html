<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - Transkrypcje - Velorie.pl</title>
    <meta name="description" content="Panel do zarządzania transkrypcjami zgłoszeń na serwerze Velorie.pl.">
    <meta name="theme-color" content="#0a1030">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --accent: #ff0354; }
        body { background-color: #00010f; background-image: radial-gradient(1200px 600px at 80% -10%, #0a1030 0%, #050919 35%, #00010f 65%, #000000 100%); }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 999px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.08); }
        @keyframes particle-animation { 0%, 100% { transform: translateY(0%) translateX(0%) rotate(0deg); } 50% { transform: translateY(-10%) translateX(5%) rotate(20deg); } }
        .particle { animation-name: particle-animation; animation-timing-function: ease-in-out; animation-iteration-count: infinite; }
    </style>
</head>
<body class="min-h-screen text-white selection:bg-[#ff0354]/40 selection:text-white">
    <div id="particles-container" aria-hidden="true" class="pointer-events-none fixed inset-0 overflow-hidden z-0"></div>

    <header class="sticky top-0 z-50 backdrop-blur-xl bg-black/20 border-b border-white/10">
        <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-4">
            <a href="/admin" class="flex items-center gap-3 flex-shrink-0">
                <img src="https://i.imgur.com/ikYb7tH.png" alt="logo" class="h-10 w-10 rounded-xl ring-1 ring-white/10">
                <div class="leading-tight hidden sm:block">
                    <div class="text-lg font-semibold tracking-tight">Velorie.pl</div>
                    <div class="text-xs text-white/60">Panel Administratora</div>
                </div>
            </a>
            <a href="/logout" class="inline-flex items-center gap-2 rounded-lg bg-white/5 px-4 py-2 text-sm font-medium hover:bg-white/10 transition">
                <i data-lucide="log-out" class="h-4 w-4"></i>
                <span>Wyloguj</span>
            </a>
        </div>
    </header>

    <main class="relative z-10 mx-auto max-w-7xl p-4 md:p-8">
        <div class="p-6 md:p-8 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl">
            
            <div>
                <h1 class="text-3xl font-bold">Panel Transkrypcji</h1>
                <p class="text-lg text-white/60 mt-2">Przeglądaj i wyszukuj transkrypcje zamkniętych zgłoszeń.</p>
                <div class="relative mt-6">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 h-5 w-5 pointer-events-none"></i>
                    <input type="text" id="searchInput" placeholder="Wyszukaj po nicku Discord (np. zxq0#1234)..." class="w-full bg-black/20 border border-white/10 rounded-lg py-3 pl-12 pr-4 text-white placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition-all">
                </div>
            </div>

            <div class="mt-8 overflow-x-auto">
                <table class="min-w-full text-left">
                    <thead class="border-b border-white/10">
                        <tr>
                            <th class="py-3 px-4 text-sm font-semibold text-white/60">ID Zgłoszenia</th>
                            <th class="py-3 px-4 text-sm font-semibold text-white/60">Otwarty przez</th>
                            <th class="py-3 px-4 text-sm font-semibold text-white/60">Temat</th>
                            <th class="py-3 px-4 text-sm font-semibold text-white/60">Data Zamknięcia</th>
                            <th class="py-3 px-4 text-sm font-semibold text-white/60 text-right">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="ticketTableBody" class="divide-y divide-white/10">
                        <tr><td colspan="5" class="text-center py-8 text-white/60">Ładowanie transkrypcji...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const createParticles = () => { /* ... kod cząsteczek ... */ };
            createParticles();

            // === GŁÓWNA LOGIKA PANELU ADMINA ===
            const ticketTableBody = document.getElementById('ticketTableBody');
            const searchInput = document.getElementById('searchInput');

            async function fetchAndRenderTickets(searchTerm = '') {
                try {
                    // Pobieramy dane z naszego API
                    const response = await fetch(`/api/tickets?search=${encodeURIComponent(searchTerm)}`);
                    
                    // Jeśli sesja wygasła, serwer zwróci błąd, a my przekierujemy na stronę logowania
                    if (!response.ok) {
                        window.location.href = '/login';
                        return;
                    }

                    const tickets = await response.json();
                    
                    ticketTableBody.innerHTML = ''; // Czyścimy tabelę przed wstawieniem nowych danych

                    if (tickets.length === 0) {
                        ticketTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-white/60">Nie znaleziono żadnych transkrypcji pasujących do kryteriów.</td></tr>`;
                        return;
                    }

                    tickets.forEach(ticket => {
                        const row = `
                            <tr class="hover:bg-white/5 transition-colors">
                                <td class="py-4 px-4 font-mono text-sm">#${ticket.transcript_id.substring(0, 6)}</td>
                                <td class="py-4 px-4">${ticket.creator_name}</td>
                                <td class="py-4 px-4">${ticket.topic}</td>
                                <td class="py-4 px-4 text-white/80">${new Date(ticket.closed_at).toLocaleString('pl-PL')}</td>
                                <td class="py-4 px-4 text-right">
                                    <a href="/${ticket.transcript_id}" target="_blank" class="inline-flex items-center gap-2 rounded-md bg-white/5 px-3 py-1.5 text-sm font-medium hover:bg-white/10 transition">
                                        <i data-lucide="eye" class="h-4 w-4"></i>
                                        <span>Zobacz</span>
                                    </a>
                                </td>
                            </tr>
                        `;
                        ticketTableBody.innerHTML += row;
                    });
                    lucide.createIcons(); // Musimy ponownie zainicjować ikony po dodaniu nowych
                } catch (error) {
                    console.error('Błąd pobierania ticketów:', error);
                    ticketTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-400">Wystąpił błąd podczas ładowania danych.</td></tr>`;
                }
            }

            // Obsługa wyszukiwarki
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                // Czekamy 300ms po ostatnim wciśnięciu klawisza, aby nie wysyłać zapytań po każdej literze
                searchTimeout = setTimeout(() => {
                    fetchAndRenderTickets(searchInput.value);
                }, 300);
            });

            // Pobranie wszystkich ticketów przy pierwszym załadowaniu strony
            fetchAndRenderTickets();
        });
    </script>
</body>
</html>
